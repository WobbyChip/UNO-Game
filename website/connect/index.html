<!DOCTYPE html>

<html lang="en" crosspilot="">
<head>
  <title>UNO Game</title>
  <link href="favicon.ico" rel="shortcut icon" type="image/x-icon">
  <link href="bootstrap.min.css" rel="stylesheet">
  <link href="connect/style.css" rel="stylesheet">
</head>

<div id="body">
  <section>
    <img draggable="false" src="images/connectBackground.jpg" id="bgimg">
    <input type="file" id="avatarUpload" style="visibility: hidden;">

    <div id="content">
      <div id="loginForm" class="modal-dialog modal-dialog-custom">
        <img class="avatar" id="avatar" width="130" height="130"></img>

        <div id="form" class="login-form">
          <div id="user">
            <input class="loginInput primaryBorderFocus form-control" id="username" name="UserName" placeholder="Username" type="text" value="">
            <div class="loginIcon" id="usernameIcon">
              <span class="icon-uno user">
                <img draggable="false" src="images/user.png">
              </span>
            </div>
          </div>

          <input type="submit" id="submit" value="Connect" class="primaryBackground" onclick="ConnectClick()">
        </div>
      </div>
    </div>

  </section>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    //Connect to socket
    var socket = io.connect();

     //Set coockie
    function SetCookie(Name, Value, Time) {
      var d = new Date();
      d.setTime(d.getTime() + Time);
      var expires = "expires=" + d.toUTCString();
      document.cookie = Name + "=" + Value + ";" + expires + ";path=/";
    }

    //Get coockie
    function GetCookie(Name) {
      var search = Name + "=";
      var ca = document.cookie.split(";");

      for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == " ") {
          c = c.substring(1);
        }
        if (c.indexOf(search) == 0) {
          return c.substring(search.length, c.length);
        }
      }

      return "";
    }

    //Upload avatar to server
    document.getElementById("avatarUpload").onchange = function(event) {
      var avatarUpload = document.getElementById("avatarUpload");
      var reader = new FileReader();
      
      reader.onloadend = async function(event) {
        var canvas = document.createElement("canvas");
        canvas.width = 130;
        canvas.height = 130;
        context = canvas.getContext("2d");
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.fillStyle = "black";
        context.fillRect(13, 13, 104, 104);
        var avatarImage = new Image();

        avatarImage.onload = function () {
          //Load frame image
          var frameImage = new Image();
          frameImage.src = "images/frame.png";

          //Draw image
          frameImage.onload = function () {
            context.drawImage(avatarImage, 13, 13, 104, 104);
            context.drawImage(frameImage, 0, 0);
            socket.emit("avatar", canvas.toDataURL());
          };
        };

        //Load avatar
        avatarImage.src = event.target.result;
      }

      //Read file
      reader.readAsDataURL(this.files[0]);
    }

    //When clicking on canvas
    document.getElementById("avatar").onclick = function(event) {
      var avatarUpload = document.getElementById("avatarUpload");
      avatarUpload.click();
    }

    //When clicking connect
    function ConnectClick() {
      var username = document.getElementById("username").value;
      var avatarURL = document.getElementById("avatar").src;
      var UID = String(new Date().getTime());
      SetCookie("username", username, 30*24*60*60*1000);
      SetCookie("uid", UID, 30*24*60*60*1000);
      SetCookie("connected", "true", 5*1000);
      socket.emit("join", {"username": username, "avatar": avatarURL, "uid": UID});
    }

    //Check if image exists
    function imageExists(imageURL){
      var http = new XMLHttpRequest();
      http.open('HEAD', imageURL, false);
      http.send();
      return http.status != 404;
    }

    //Load data from cookies and avatar
    document.getElementById("username").value = GetCookie("username");
    var avatarURL = GetCookie("avatar");

    //Load avatar
    if (imageExists(avatarURL) && (avatarURL != "")) {
      document.getElementById("avatar").src = avatarURL;
    } else {
      document.getElementById("avatar").src = "images/defaultAvatar.png";
    }

    //Alert if game already started
    socket.on("avatar", function(data) {
      SetCookie("avatar", data, 30*24*60*60*1000);
      document.getElementById("avatar").src = data;
    });

    //Reload page on socket command 'reload'
    socket.on("reload", function () {
      location.reload();
    });

    //Alert if game already started
    socket.on("started", function() {
      alert("Game already started!");
    });
  </script>
</div>
</html>